<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Konfigurátor řemínku</title>
    <script
      type="module"
      src="https://cdnjs.cloudflare.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"
    ></script>
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
      window.THREE = THREE;
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 10px;
      }

      model-viewer {
        min-width: 100%;
        min-height: 90vh;
     
        max-height: 600px;
      }

      .tabs {
      width: 200px;
      
        }

      .tab {
        padding: 5px;
        margin: 5px;
        width: 200px;
        text-align: left;

      }

      .controls label {
        display: flex;
        margin-top: 10px;
        font-size: 0.7rem;
      }

      .control-pair {
        display: table-caption;
        align-items: center;
      }

      .control-pair input[type='range'] {
        flex: 1;
        height: 20px;
      }

      .control-pair input[type='number'] {
        width: 40px;
        padding: 2px;
  font-size: 0.8rem;
      }

      .card {
        background-color: rgba(255, 255, 255, 0.7); /* poloprůhledné bílé pozadí */
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

      .tabs-row {
        display: block;
        font-size: 0.8rem;
        
      }

      .tabs-row .card {
        max-width: 100%;
        
      }

      .toggle-button {
       background: none;
        border: none;
        font-size: 1em;
       cursor: pointer;
       
        }

        .card {
  height: auto;
  transition: height 0.3s ease;
  overflow: hidden;
}

.collapsible {
  display: none;
}

.collapsible.open {
  display: block;
}

            h4 {
        font-size: 0.9rem;
        margin:0px;
        padding:4px;
        
      }
    </style>
  </head>
  <body>
    <h2>3D Konfigurátor řemínku</h2>
    
      <model-viewer
        id="watchModel"
        class="card"
        src="https://cdn.jsdelivr.net/gh/phovorka/GLB/UV3.glb"
        camera-controls
        ar
      >
    
     
        <div class="tabs">
          <div class="tabs-row">
          <!-- Materiál 1 a 2 -->
            <div class="tab card">
              <h4>
                <button class="toggle-button" data-target="material1Controls">►</button>
                Barva řemínku
              </h4>
              <div class="controls collapsible" id="material1Controls">
                <label>Barva:</label>
              <input type="color" id="sharedColorPicker" value="#ffffff" />
            </div>
          </div>
            <!-- Materiál 3 -->
            <div class="tab card">
              <h4>
                <button class="toggle-button" data-target="material3Controls">►</button>
                Potisk "levý"
              </h4>
              <div class="controls collapsible" id="material3Controls">


              <label>Nahraj obrázek</label>
              <input type="file" id="textureInput3" accept="image/*" />
                <label>Posun X:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetX3"
                  />
                  <input
                    type="number"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetX3Number"
                  />
                </div>
                <label>Posun Y:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetY3"
                  />
                  <input
                    type="number"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetY3Number"
                  />
                </div>
                <label>Měřítko:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="0.1"
                    max="4"
                    step="0.1"
                    value="1"
                    id="scale3"
                  />
                  <input
                    type="number"
                    min="0.1"
                    max="4"
                    step="0.1"
                    value="1"
                    id="scale3Number"
                  />
                </div>
                <label>Rotace (°):</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="0"
                    max="360"
                    step="1"
                    value="0"
                    id="rotation3"
                  />
                  <input
                    type="number"
                    min="0"
                    max="360"
                    step="1"
                    value="0"
                    id="rotation3Number"
                  />
                </div>
              </div>
            </div>
  
            <!-- Materiál 4 -->
            <div class="tab card">
              <h4>
                <button class="toggle-button" data-target="material4Controls">►</button>
                Potisk "pravý"
              </h4>
              <div class="controls collapsible" id="material4Controls">

              <label>Nahraj obrázek</label>
              <input type="file" id="textureInput4" accept="image/*" />
           
                <label>Posun X:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetX4"
                  />
                  <input
                    type="number"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetX4Number"
                  />
                </div>
                <label>Posun Y:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetY4"
                  />
                  <input
                    type="number"
                    min="-5"
                    max="5"
                    step="0.1"
                    value="0"
                    id="offsetY4Number"
                  />
                </div>
                <label>Měřítko:</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="0.1"
                    max="4"
                    step="0.1"
                    value="1"
                    id="scale4"
                  />
                  <input
                    type="number"
                    min="0.1"
                    max="4"
                    step="0.1"
                    value="1"
                    id="scale4Number"
                  />
                </div>
                <label>Rotace (°):</label>
                <div class="control-pair">
                  <input
                    type="range"
                    min="0"
                    max="360"
                    step="1"
                    value="0"
                    id="rotation4"
                  />
                  <input
                    type="number"
                    min="0"
                    max="360"
                    step="1"
                    value="0"
                    id="rotation4Number"
                  />
                </div>
              </div>
            </div>
          </div>
        
    </model-viewer>

    </div>

    <script>
      const textureTransforms = {
        3: { offsetX: 0, offsetY: 0, scale: 2, rotation: 0 },
        4: { offsetX: 0, offsetY: 0, scale: 2, rotation: 0 },
      };

      function degreesToRadians(deg) {
        return (deg * Math.PI) / 180;
      }

      function applyTextureTransform(materialIndex) {
        const model = document.querySelector('#watchModel').model;
        if (!model) return;

        const material = model.materials[materialIndex];
        if (!material) return;

        const tex = material.pbrMetallicRoughness.baseColorTexture;
        if (!tex || !tex.texture || !tex.texture.sampler) return;

        const sampler = tex.texture.sampler;
        const tf = textureTransforms[materialIndex];

        const center = 0.5;
        const offsetX =
          tf.offsetX + center - center * tf.scale * Math.cos(tf.rotation);
        const offsetY =
          tf.offsetY + center - center * tf.scale * Math.cos(tf.rotation);

        sampler.setOffset({ u: offsetX, v: offsetY });
        sampler.setScale({ u: tf.scale, v: tf.scale });
        sampler.setRotation(tf.rotation);
        sampler.setWrapS(33071); // CLAMP_TO_EDGE
        sampler.setWrapT(33071);
      }

      function hexToRgb(hex) {
        const bigint = parseInt(hex.replace('#', ''), 16);
        return [
          ((bigint >> 16) & 255) / 255,
          ((bigint >> 8) & 255) / 255,
          (bigint & 255) / 255,
          1,
        ];
      }

      function bindDualInput(idBase, onChange) {
        const range = document.getElementById(idBase);
        const number = document.getElementById(idBase + 'Number');

        const sync = (value) => {
          range.value = value;
          number.value = value;
          onChange(parseFloat(value));
        };

        range.addEventListener('input', (e) => sync(e.target.value));
        number.addEventListener('input', (e) => sync(e.target.value));
      }

      function bindControls(materialIndex) {
        const update = () => applyTextureTransform(materialIndex);

        bindDualInput(`offsetX${materialIndex}`, (val) => {
          textureTransforms[materialIndex].offsetX = val;
          update();
        });

        bindDualInput(`offsetY${materialIndex}`, (val) => {
          textureTransforms[materialIndex].offsetY = val;
          update();
        });

        bindDualInput(`scale${materialIndex}`, (val) => {
          textureTransforms[materialIndex].scale = val;
          update();
        });

        bindDualInput(`rotation${materialIndex}`, (val) => {
          textureTransforms[materialIndex].rotation = degreesToRadians(val);
          update();
        });
      }

      function bindTextureUpload(materialIndex) {
        const input = document.getElementById(`textureInput${materialIndex}`);
        input.addEventListener('change', async function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async function (e) {
            const modelViewer = document.querySelector('#watchModel');
            await modelViewer.updateComplete;
            const model = modelViewer.model;
            if (!model) return;

            const material = model.materials[materialIndex];
            if (!material) return;

            const texture = await modelViewer.createTexture(e.target.result);
            material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
            applyTextureTransform(materialIndex);
          };
          reader.readAsDataURL(file);
        });
      }



      function bindSharedColorPicker(materialIndices) {
        const input = document.getElementById('sharedColorPicker');
        input.addEventListener('input', async function (e) {
          const modelViewer = document.querySelector('#watchModel');
          await modelViewer.updateComplete;
          const model = modelViewer.model;
          if (!model) return;

          const color = hexToRgb(e.target.value);
          materialIndices.forEach((index) => {
            const material = model.materials[index];
            if (material) {
              material.pbrMetallicRoughness.setBaseColorFactor(color);
            }
          });
        });
      }

      async function loadDefaultTexture(materialIndex, url) {
  const modelViewer = document.querySelector('#watchModel');
  await modelViewer.updateComplete;
  const model = modelViewer.model;
  if (!model) return;

  const material = model.materials[materialIndex];
  if (!material) return;

  const texture = await modelViewer.createTexture(url);
  material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
  // Nastavíme správné počáteční transformace
  textureTransforms[materialIndex] = {
    offsetX: 0,
    offsetY: 0,
    scale: 1,        // důležité!
    rotation: 0
  };
  applyTextureTransform(materialIndex);
}


      document
        .querySelector('#watchModel')
        .addEventListener('load', async () => {
          const modelViewer = document.querySelector('#watchModel');
          await modelViewer.updateComplete;

          [3, 4].forEach((index) => {
            bindControls(index);
            bindTextureUpload(index);
         
 // Nastavíme napevno bílou barvu
 const material = modelViewer.model.materials[index];
      if (material) {
        material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]);
      }
    });
    // Sem vložíš URL obrázků
    await loadDefaultTexture(3, 'https://cdn.jsdelivr.net/gh/phovorka/GLB/potisk levy.jpg');
    await loadDefaultTexture(4, 'https://cdn.jsdelivr.net/gh/phovorka/GLB/Potisk pravy.jpg');
          bindSharedColorPicker([2]);
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const toggleButtons = document.querySelectorAll('.toggle-button');

    toggleButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const target = document.getElementById(targetId);

        const isOpen = target.classList.contains('open');
        target.classList.toggle('open');
        btn.textContent = isOpen ? '►' : '▼';
      });
    });
  });
    </script>
  </body>
</html>
